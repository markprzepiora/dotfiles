#!/usr/bin/env bash

set -o pipefail

if [[ $# -eq 1 ]]; then
    selected=$1
else
    selected=$(
        (find ~/projects ~/src ~/work ~/Obsidian -mindepth 1 -maxdepth 1 -type d
        echo personal
        echo work
    ) | fzf)
fi

if [[ -z $selected ]]; then
    exit 0
fi

case "$selected" in
    "personal")
        selected_name="personal" ;;
    *)
        selected_name="$(basename $(realpath "$selected/..") | tr . _)-$(basename "$selected" | tr . _)" ;;
esac

if [[ -z $TMUX ]] && [[ -z "$(pgrep tmux)" ]]; then
    # If tmux is not running, it's okay to attach to the session right away
    detach_flag=""
else
    # If tmux is already running, tmux will complain unless we pass the -d flag
    detach_flag="-d"
fi

if ! tmux has-session -t="$selected_name" 2> /dev/null; then
    if command -v "tmux-${selected_name}" >/dev/null 2>&1; then
        # If there is a custom tmux session script for this project, run it instead
        "tmux-${selected_name}"
    else
        # Otherwise, just start a new tmux session in the selected directory
        tmux new-session $detach_flag -s $selected_name -c "$selected"
    fi
fi

if [[ -z $TMUX ]]; then
    tmux attach -t "$selected_name"
else
    tmux switch-client -t "$selected_name"
fi

# vim: ts=4 sts=4 sw=4 et
