#!/usr/bin/env bash

# Cheat sheet:
# https://kapeli.com/cheat_sheets/Bash_Test_Operators.docset/Contents/Resources/Documents/index

set -o pipefail
set -e

declare -A quick_commands
declare -a quick_commands_order

add_command() {
  local command_name="$1"
  local command_action="$2"
  quick_commands["$command_name"]="$command_action"
  quick_commands_order+=("$command_name")
}

if [[ -n $WAYLAND_DISPLAY ]] && grep --silent --no-messages i7-1355U /proc/cpuinfo; then
  if [[ -t 1 ]]; then
    add_command "(Power) Performance mode" "sudo cpupower frequency-set -g performance && sudo cpupower set -b 0"
    add_command "(Power) Power saving mode" "sudo cpupower frequency-set -g powersave && sudo cpupower set -b 1"
  fi
  add_command "(Network) Wi-Fi" "impala"
  add_command "(Home VPN) Connect" "wg-quick up home"
  add_command "(Home VPN) Disconnect" "wg-quick down home"
  add_command "(Audio) Connect headset" "bluetoothctl connect 20:AF:1B:0A:44:D6"
  add_command "(Audio) Disconnect headset" "bluetoothctl disconnect 20:AF:1B:0A:44:D6"
  add_command "(Audio) High Quality Bluetooth" "bluetoothctl connect 20:AF:1B:0A:44:D6 && sleep 1 && pactl set-card-profile bluez_card.20_AF_1B_0A_44_D6 a2dp-sink-sbc_xq"
  add_command "(Audio) Bluetooth with microphone" "bluetoothctl connect 20:AF:1B:0A:44:D6 && sleep 1 && pactl set-card-profile bluez_card.20_AF_1B_0A_44_D6 headset-head-unit"
  add_command "(Audio) Restart services" "systemctl --user restart wireplumber pipewire pipewire-pulse"
  if [[ -t 1 ]]; then
    add_command '(Display) Medium brightness' 'echo 10000 | sudo tee /sys/class/backlight/intel_backlight/brightness'
    add_command '(Display) Low brightness' 'echo 5000 | sudo tee /sys/class/backlight/intel_backlight/brightness'
  fi
  add_command '(Webcam) Set exposure' 'v4l2-ctl -c backlight_compensation=0 -c gamma=120 -c exposure_dynamic_framerate=0 -c brightness=100'
fi

if [[ -n $WAYLAND_DISPLAY ]]; then
  add_command "(XDG) Restart desktop portal services" "killall xdg-desktop-portal && killall xdg-desktop-portal-gtk && killall xdg-desktop-portal-hyprland && systemctl --user restart xdg-desktop-portal.service"
fi

add_command '(Procs) Kill process by listening port' 'lsof -sTCP:LISTEN -Pni | fzf --multi --header-lines=1 | while read _ pid rest; do echo $pid; done | xargs kill'

if [[ -t 1 ]]; then
  # Terminal
  for command in "${quick_commands_order[@]}"; do
    echo "$command"
  done | fzf --query="$1" | while read -r selected_command; do
    if [[ -n $selected_command ]]; then
      if [[ -n ${quick_commands[$selected_command]}
      ]]; then
        eval "${quick_commands[$selected_command]}"
      else
        echo "Command not found: $selected_command"
      fi
    else
      echo "No command selected."
    fi
  done
else
  # GUI
  for command in "${quick_commands_order[@]}"; do
    echo "$command"
  done | bemenu -c -i -l 20 --fixed-height -W 0.8 --fn "CaskaydiaMono Nerd Font 15" | while read -r selected_command; do
    if [[ -n $selected_command ]]; then
      if [[ -n ${quick_commands[$selected_command]}
      ]]; then
        eval "${quick_commands[$selected_command]}"
      else
        echo "Command not found: $selected_command"
      fi
    else
      echo "No command selected."
    fi
  done
fi
